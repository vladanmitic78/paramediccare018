#cloud-config
# Paramedic Care 018 - Hetzner VPS Cloud Init Configuration
# Ubuntu 24.04 LTS

package_update: true
package_upgrade: true

packages:
  - nginx
  - certbot
  - python3-certbot-nginx
  - docker.io
  - docker-compose
  - git
  - ufw
  - fail2ban
  - htop
  - curl
  - wget

# Create deploy user
users:
  - name: deploy
    groups: sudo, docker
    shell: /bin/bash
    sudo: ['ALL=(ALL) NOPASSWD:ALL']
    ssh_authorized_keys:
      - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIA3PIXO9m9ASYN2BntXV+V5SvwvpbuhgYxhf+I85ciCp paramedic-care018-hetzner

# Write configuration files
write_files:
  # Docker Compose for the application
  - path: /opt/paramedic-care/docker-compose.yml
    content: |
      version: '3.8'
      services:
        mongodb:
          image: mongo:7
          restart: always
          volumes:
            - mongodb_data:/data/db
          environment:
            MONGO_INITDB_DATABASE: paramedic_care_018

        backend:
          build: ./backend
          restart: always
          ports:
            - "8001:8001"
          environment:
            - MONGO_URL=mongodb://mongodb:27017
            - DB_NAME=paramedic_care_018
            - JWT_SECRET=${JWT_SECRET}
          depends_on:
            - mongodb

        frontend:
          build: ./frontend
          restart: always
          ports:
            - "3000:3000"
          environment:
            - REACT_APP_BACKEND_URL=https://paramedic-care018.rs

      volumes:
        mongodb_data:

  # Nginx configuration
  - path: /etc/nginx/sites-available/paramedic-care018
    content: |
      server {
          listen 80;
          server_name paramedic-care018.rs www.paramedic-care018.rs;

          location / {
              proxy_pass http://localhost:3000;
              proxy_http_version 1.1;
              proxy_set_header Upgrade $http_upgrade;
              proxy_set_header Connection 'upgrade';
              proxy_set_header Host $host;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto $scheme;
              proxy_cache_bypass $http_upgrade;
          }

          location /api {
              proxy_pass http://localhost:8001;
              proxy_http_version 1.1;
              proxy_set_header Upgrade $http_upgrade;
              proxy_set_header Connection 'upgrade';
              proxy_set_header Host $host;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto $scheme;
              proxy_read_timeout 300s;
              proxy_connect_timeout 75s;
          }

          location /ws {
              proxy_pass http://localhost:8001;
              proxy_http_version 1.1;
              proxy_set_header Upgrade $http_upgrade;
              proxy_set_header Connection "upgrade";
              proxy_set_header Host $host;
              proxy_read_timeout 86400;
          }
      }

  # UFW rules script
  - path: /opt/scripts/setup-firewall.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      ufw default deny incoming
      ufw default allow outgoing
      ufw allow ssh
      ufw allow http
      ufw allow https
      ufw --force enable

  # Deploy script
  - path: /opt/scripts/deploy.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      cd /opt/paramedic-care
      git pull origin main
      docker-compose down
      docker-compose build --no-cache
      docker-compose up -d
      echo "Deployment complete!"

# Run commands after boot
runcmd:
  # Enable and start Docker
  - systemctl enable docker
  - systemctl start docker
  
  # Setup firewall
  - /opt/scripts/setup-firewall.sh
  
  # Enable fail2ban
  - systemctl enable fail2ban
  - systemctl start fail2ban
  
  # Setup Nginx
  - ln -sf /etc/nginx/sites-available/paramedic-care018 /etc/nginx/sites-enabled/
  - rm -f /etc/nginx/sites-enabled/default
  - nginx -t && systemctl reload nginx
  
  # Create app directory
  - mkdir -p /opt/paramedic-care
  - chown -R deploy:deploy /opt/paramedic-care
  
  # Print completion message
  - echo "Cloud-init setup complete! Server is ready for deployment."

final_message: |
  Paramedic Care 018 server setup complete!
  
  Next steps:
  1. Point DNS (paramedic-care018.rs) to this server's IP
  2. SSH in: ssh -i hetzner_key deploy@YOUR_SERVER_IP
  3. Clone your repo: git clone YOUR_GITHUB_REPO /opt/paramedic-care
  4. Run SSL setup: sudo certbot --nginx -d paramedic-care018.rs -d www.paramedic-care018.rs
  5. Deploy: cd /opt/paramedic-care && docker-compose up -d
