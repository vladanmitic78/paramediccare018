name: Deploy to Hetzner

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 46.225.75.191
          username: root
          key: ${{ secrets.HETZNER_SSH_KEY }}
          port: 22
          command_timeout: 30m
          script: |
            echo "ðŸ” Finding app directory..."
            
            # Find the app directory (look for common locations)
            APP_PATH=""
            for path in /var/www/paramediccare018 /var/www/paramedic-care /home/paramedic /root/paramediccare018 /opt/paramediccare018; do
              if [ -d "$path" ] && [ -f "$path/backend/server.py" ]; then
                APP_PATH="$path"
                break
              fi
            done
            
            # If not found, search for it
            if [ -z "$APP_PATH" ]; then
              APP_PATH=$(find /var/www /home /opt /root -maxdepth 3 -name "server.py" -path "*/backend/*" 2>/dev/null | head -1 | sed 's|/backend/server.py||')
            fi
            
            if [ -z "$APP_PATH" ]; then
              echo "âŒ Could not find app directory!"
              exit 1
            fi
            
            echo "âœ… Found app at: $APP_PATH"
            cd "$APP_PATH"
            
            echo "ðŸ“¥ Pulling latest code..."
            git pull origin main
            
            echo "ðŸ Updating backend dependencies..."
            cd backend
            pip3 install -r requirements.txt --quiet
            
            echo "ðŸ“¦ Updating frontend dependencies..."
            cd ../frontend
            yarn install --silent
            
            echo "ðŸ”¨ Building frontend..."
            yarn build
            
            echo "ðŸ”„ Restarting services..."
            # Try PM2 first, then systemctl
            if command -v pm2 &> /dev/null; then
              pm2 restart all || echo "PM2 restart attempted"
            fi
            
            # Try systemctl if service exists
            if systemctl list-units --type=service | grep -q "paramedic"; then
              sudo systemctl restart paramedic* || echo "Systemctl restart attempted"
            fi
            
            echo "âœ… Deployment complete!"
