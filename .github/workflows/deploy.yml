name: Deploy to Hetzner

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 46.225.75.191
          username: root
          key: ${{ secrets.HETZNER_SSH_KEY }}
          port: 22
          command_timeout: 30m
          script: |
            echo "ğŸ” App directory: /opt/paramedic-care"
            APP_PATH="/opt/paramedic-care"
            
            # Fix git ownership issue
            git config --global --add safe.directory "$APP_PATH"
            
            cd "$APP_PATH"
            
            echo "ğŸ“¥ Pulling latest code (force sync with GitHub)..."
            git fetch origin main
            git reset --hard origin/main
            
            echo "ğŸ Updating backend dependencies..."
            cd backend
            # Install pip if missing, then install requirements
            python3 -m ensurepip --upgrade 2>/dev/null || apt-get install -y python3-pip 2>/dev/null || true
            python3 -m pip install -r requirements.txt --quiet 2>/dev/null || pip3 install -r requirements.txt --quiet 2>/dev/null || echo "âš ï¸ pip install skipped"
            
            echo "ğŸ“¦ Updating frontend..."
            cd ../frontend
            
            # Source nvm
            export NVM_DIR="/root/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            
            # Find and use node/npm/yarn
            export PATH="$PATH:/usr/local/bin:/root/.nvm/versions/node/v18.20.8/bin:/root/.nvm/versions/node/v20.20.0/bin"
            
            if command -v npm &> /dev/null; then
              echo "Found npm, installing dependencies..."
              npm install --legacy-peer-deps 2>/dev/null || npm install
              echo "ğŸ”¨ Building frontend..."
              npm run build
            else
              echo "âš ï¸ npm not found, checking for pre-built files..."
              ls -la build/ 2>/dev/null || echo "No build folder found"
            fi
            
            echo "ğŸ”„ Restarting services..."
            # Source nvm again for pm2
            export NVM_DIR="/root/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            
            # Restart with pm2
            pm2 restart all 2>/dev/null && echo "âœ… PM2 restarted" || echo "PM2 not available"
            
            # Or systemctl
            systemctl restart paramedic-backend 2>/dev/null || true
            systemctl restart paramedic-frontend 2>/dev/null || true
            systemctl restart nginx 2>/dev/null || true
            
            echo "âœ… Deployment complete!"
            echo "ğŸ“ Current files:"
            ls -la
