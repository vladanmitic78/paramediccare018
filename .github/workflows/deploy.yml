name: Deploy to Hetzner

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 46.225.75.191
          username: root
          key: ${{ secrets.HETZNER_SSH_KEY }}
          port: 22
          command_timeout: 30m
          script: |
            echo "ğŸ” App directory: /opt/paramedic-care"
            APP_PATH="/opt/paramedic-care"
            
            # Fix git ownership issue
            git config --global --add safe.directory "$APP_PATH"
            
            cd "$APP_PATH"
            
            echo "ğŸ“¥ Pulling latest code..."
            git fetch origin main
            git reset --hard origin/main
            
            # ============ BACKEND ============
            echo "ğŸ Updating backend dependencies..."
            cd backend
            
            # Install emergentintegrations from special URL first (without version constraint)
            python3 -m pip install emergentintegrations --extra-index-url https://d33sy5i8bnduwe.cloudfront.net/simple/ --upgrade --quiet 2>/dev/null || true
            
            # Install other requirements (ignore version errors)
            python3 -m pip install -r requirements.txt --quiet 2>/dev/null || echo "âš ï¸ Some pip packages may have failed"
            
            # ============ FRONTEND ============
            echo "ğŸ“¦ Building frontend..."
            cd ../frontend
            
            # Only rebuild if node_modules missing or package.json changed
            if [ ! -d "node_modules" ]; then
              echo "Installing npm dependencies..."
              npm install --legacy-peer-deps
            fi
            
            echo "ğŸ”¨ Building frontend..."
            npm run build
            
            # ============ CHECK NGINX CONFIG ============
            echo "ğŸ” Checking Nginx configuration..."
            
            # Find where nginx is serving from
            NGINX_ROOT=$(grep -r "root" /etc/nginx/sites-enabled/ 2>/dev/null | grep -v "#" | head -1 | awk '{print $2}' | tr -d ';')
            echo "Nginx root: $NGINX_ROOT"
            
            # Show nginx config
            echo "--- Nginx sites-enabled ---"
            ls -la /etc/nginx/sites-enabled/
            cat /etc/nginx/sites-enabled/* 2>/dev/null | head -100
            
            # If nginx serves from a different location, copy build there
            if [ -n "$NGINX_ROOT" ] && [ "$NGINX_ROOT" != "$APP_PATH/frontend/build" ]; then
              echo "ğŸ“‹ Copying build to nginx root: $NGINX_ROOT"
              cp -r frontend/build/* "$NGINX_ROOT/" 2>/dev/null || echo "Could not copy to $NGINX_ROOT"
            fi
            
            # ============ RESTART SERVICES ============
            echo "ğŸ”„ Restarting services..."
            
            # Check what's already running
            echo "--- Currently running processes ---"
            ps aux | grep -E "(uvicorn|gunicorn|node|python.*server)" | grep -v grep || true
            
            # Check for systemctl services
            echo "--- Systemctl services ---"
            systemctl list-units --type=service | grep -E "(paramedic|uvicorn|gunicorn|node)" || true
            
            # Try to restart any existing services
            systemctl restart paramedic-backend 2>/dev/null && echo "âœ… paramedic-backend restarted" || true
            systemctl restart paramedic-frontend 2>/dev/null && echo "âœ… paramedic-frontend restarted" || true
            systemctl restart backend 2>/dev/null && echo "âœ… backend restarted" || true
            systemctl restart frontend 2>/dev/null && echo "âœ… frontend restarted" || true
            
            # Restart PM2 if running
            pm2 restart all 2>/dev/null && echo "âœ… PM2 restarted" || true
            
            # Restart nginx
            systemctl restart nginx && echo "âœ… Nginx restarted"
            
            # Clear nginx cache if exists
            rm -rf /var/cache/nginx/* 2>/dev/null || true
            
            echo "âœ… Deployment complete!"
            echo ""
            echo "--- Final status ---"
            pm2 list 2>/dev/null || true
            systemctl status nginx --no-pager | head -10
