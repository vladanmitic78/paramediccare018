name: Deploy to Hetzner

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 46.225.75.191
          username: root
          key: ${{ secrets.HETZNER_SSH_KEY }}
          port: 22
          command_timeout: 30m
          script: |
            echo "ğŸ” App directory: /opt/paramedic-care"
            APP_PATH="/opt/paramedic-care"
            
            git config --global --add safe.directory "$APP_PATH"
            cd "$APP_PATH"
            
            echo "ğŸ“¥ Pulling latest code..."
            git fetch origin main
            git reset --hard origin/main
            
            # ============ KILL OLD PROCESSES ============
            echo "ğŸ”ª Stopping old processes..."
            
            # Kill any old uvicorn processes NOT managed by PM2
            pkill -f "uvicorn server:app" 2>/dev/null || true
            pkill -f "python.*server" 2>/dev/null || true
            
            # Stop PM2 processes to avoid conflicts
            pm2 stop all 2>/dev/null || true
            pm2 delete all 2>/dev/null || true
            
            # Wait for ports to be released
            sleep 2
            
            # ============ BACKEND ============
            echo "ğŸ Updating backend..."
            cd backend
            python3 -m pip install emergentintegrations --extra-index-url https://d33sy5i8bnduwe.cloudfront.net/simple/ --upgrade --quiet 2>/dev/null || true
            python3 -m pip install -r requirements.txt --quiet 2>/dev/null || true
            
            # ============ FRONTEND ============
            echo "ğŸ“¦ Building frontend..."
            cd ../frontend
            
            # Force rebuild to ensure new code is built
            rm -rf build
            npm run build
            
            echo "âœ… Build complete!"
            ls -la build/static/js/ | head -5
            
            # ============ START SERVICES WITH PM2 ============
            echo "ğŸš€ Starting services with PM2..."
            cd "$APP_PATH"
            
            # Start backend with uvicorn via PM2
            pm2 start "uvicorn server:app --host 0.0.0.0 --port 8001" --name backend --cwd "$APP_PATH/backend"
            
            # Start frontend static server via PM2
            pm2 serve "$APP_PATH/frontend/build" 3000 --name frontend --spa
            
            # Save PM2 config
            pm2 save
            
            # Show status
            pm2 list
            
            # Restart nginx
            systemctl restart nginx
            
            echo ""
            echo "âœ… Deployment complete!"
            echo "ğŸŒ Check: https://paramedic-care018.rs"
