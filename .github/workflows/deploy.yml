name: Deploy to Hetzner

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 46.225.75.191
          username: root
          key: ${{ secrets.HETZNER_SSH_KEY }}
          port: 22
          command_timeout: 30m
          script: |
            echo "ðŸ” Finding app directory..."
            
            # App path (found from previous run)
            APP_PATH="/opt/paramedic-care"
            
            if [ ! -d "$APP_PATH" ]; then
              echo "âŒ App directory not found!"
              exit 1
            fi
            
            echo "âœ… Found app at: $APP_PATH"
            
            # Fix git ownership issue
            echo "ðŸ”§ Fixing git safe directory..."
            git config --global --add safe.directory "$APP_PATH"
            
            cd "$APP_PATH"
            
            echo "ðŸ“¥ Pulling latest code..."
            git pull origin main
            
            echo "ðŸ Updating backend dependencies..."
            cd backend
            # Try different pip paths
            if command -v pip3 &> /dev/null; then
              pip3 install -r requirements.txt --quiet
            elif command -v /usr/bin/pip3 &> /dev/null; then
              /usr/bin/pip3 install -r requirements.txt --quiet
            elif command -v python3 &> /dev/null; then
              python3 -m pip install -r requirements.txt --quiet
            else
              echo "âš ï¸ pip3 not found, skipping backend deps"
            fi
            
            echo "ðŸ“¦ Updating frontend dependencies..."
            cd ../frontend
            
            # Source nvm if available
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            
            # Try different yarn/npm paths
            if command -v yarn &> /dev/null; then
              yarn install --silent
              echo "ðŸ”¨ Building frontend..."
              yarn build
            elif command -v /usr/local/bin/yarn &> /dev/null; then
              /usr/local/bin/yarn install --silent
              echo "ðŸ”¨ Building frontend..."
              /usr/local/bin/yarn build
            elif [ -f "$HOME/.yarn/bin/yarn" ]; then
              $HOME/.yarn/bin/yarn install --silent
              echo "ðŸ”¨ Building frontend..."
              $HOME/.yarn/bin/yarn build
            elif command -v npm &> /dev/null; then
              npm install --silent
              echo "ðŸ”¨ Building frontend..."
              npm run build
            else
              echo "âš ï¸ yarn/npm not found, skipping frontend build"
            fi
            
            echo "ðŸ”„ Restarting services..."
            # Try PM2 first
            if command -v pm2 &> /dev/null; then
              pm2 restart all 2>/dev/null || echo "PM2 restart attempted"
            elif [ -f "$HOME/.nvm/versions/node/*/bin/pm2" ]; then
              $HOME/.nvm/versions/node/*/bin/pm2 restart all 2>/dev/null || echo "PM2 restart attempted"
            fi
            
            # Try systemctl if service exists
            if systemctl list-units --type=service 2>/dev/null | grep -q "paramedic"; then
              systemctl restart paramedic* || echo "Systemctl restart attempted"
            fi
            
            echo "âœ… Deployment complete!"
