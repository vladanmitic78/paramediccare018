name: Deploy to Hetzner

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 46.225.75.191
          username: root
          key: ${{ secrets.HETZNER_SSH_KEY }}
          port: 22
          command_timeout: 30m
          script: |
            echo "ðŸ” App directory: /opt/paramedic-care"
            APP_PATH="/opt/paramedic-care"
            
            # Fix git ownership issue
            git config --global --add safe.directory "$APP_PATH"
            
            cd "$APP_PATH"
            
            echo "ðŸ“¥ Pulling latest code..."
            git fetch origin main
            git reset --hard origin/main
            
            # ============ INSTALL NODE.JS IF MISSING ============
            if ! command -v node &> /dev/null; then
              echo "ðŸ“¦ Installing Node.js..."
              curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
              apt-get install -y nodejs
              echo "âœ… Node.js installed: $(node --version)"
            else
              echo "âœ… Node.js already installed: $(node --version)"
            fi
            
            # Install PM2 globally if missing
            if ! command -v pm2 &> /dev/null; then
              echo "ðŸ“¦ Installing PM2..."
              npm install -g pm2
            fi
            
            # ============ BACKEND ============
            echo "ðŸ Updating backend dependencies..."
            cd backend
            
            # Install pip if missing
            if ! python3 -m pip --version &> /dev/null; then
              apt-get install -y python3-pip
            fi
            python3 -m pip install -r requirements.txt --quiet || echo "âš ï¸ Some pip packages may have failed"
            
            # ============ FRONTEND ============
            echo "ðŸ“¦ Updating frontend..."
            cd ../frontend
            
            echo "Installing npm dependencies..."
            npm install --legacy-peer-deps
            
            echo "ðŸ”¨ Building frontend..."
            npm run build
            
            echo "âœ… Build complete! Files in build/:"
            ls -la build/ | head -10
            
            # ============ RESTART SERVICES ============
            echo "ðŸ”„ Restarting services..."
            
            cd "$APP_PATH"
            
            # Check if PM2 processes exist, if not start them
            if pm2 list | grep -q "online\|stopped"; then
              pm2 restart all
              echo "âœ… PM2 processes restarted"
            else
              echo "âš ï¸ No PM2 processes found. You may need to start them manually."
              echo "Run: pm2 start backend/server.py --name backend --interpreter python3"
              echo "Run: pm2 serve frontend/build 3000 --name frontend --spa"
            fi
            
            # Restart nginx if exists
            systemctl restart nginx 2>/dev/null && echo "âœ… Nginx restarted" || true
            
            echo "âœ… Deployment complete!"
