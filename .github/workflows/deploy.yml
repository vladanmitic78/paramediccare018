name: Deploy to Hetzner

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 46.225.75.191
          username: root
          key: ${{ secrets.HETZNER_SSH_KEY }}
          port: 22
          command_timeout: 30m
          script: |
            echo "ðŸ” App directory: /opt/paramedic-care"
            APP_PATH="/opt/paramedic-care"
            
            git config --global --add safe.directory "$APP_PATH"
            cd "$APP_PATH"
            
            echo "ðŸ“¥ Pulling latest code (safe merge)..."
            git stash 2>/dev/null || true
            git pull origin main --no-rebase
            
            echo "ðŸ“¦ Building frontend..."
            cd frontend
            npm run build 2>/dev/null || echo "Build skipped"
            
            echo "ðŸ”„ Restarting services..."
            pm2 restart all 2>/dev/null || true
            systemctl restart nginx 2>/dev/null || true
            
            echo "âœ… Done"
