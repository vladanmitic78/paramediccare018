name: Deploy to Hetzner

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 46.225.75.191
          username: root
          key: ${{ secrets.HETZNER_SSH_KEY }}
          port: 22
          command_timeout: 30m
          script: |
            echo "ðŸ” App directory: /opt/paramedic-care"
            APP_PATH="/opt/paramedic-care"
            
            # Fix git ownership issue
            git config --global --add safe.directory "$APP_PATH"
            
            cd "$APP_PATH"
            
            echo "ðŸ“¥ Pulling latest code..."
            git fetch origin main
            git reset --hard origin/main
            
            # ============ BACKEND ============
            echo "ðŸ Updating backend dependencies..."
            cd backend
            
            # Install pip if missing
            if ! python3 -m pip --version &> /dev/null; then
              apt-get install -y python3-pip
            fi
            
            # Install emergentintegrations from special URL first
            python3 -m pip install emergentintegrations --extra-index-url https://d33sy5i8bnduwe.cloudfront.net/simple/ --quiet || true
            
            # Install other requirements
            python3 -m pip install -r requirements.txt --quiet || echo "âš ï¸ Some pip packages may have failed"
            
            # ============ FRONTEND ============
            echo "ðŸ“¦ Updating frontend..."
            cd ../frontend
            
            # Clean install to avoid dependency conflicts
            echo "ðŸ§¹ Cleaning old node_modules..."
            rm -rf node_modules package-lock.json
            
            echo "Installing npm dependencies (fresh install)..."
            npm install --legacy-peer-deps
            
            # Fix ajv dependency issue
            npm install ajv@8 --save-dev --legacy-peer-deps
            
            echo "ðŸ”¨ Building frontend..."
            npm run build
            
            echo "âœ… Build complete! Files in build/:"
            ls -la build/ | head -10
            
            # ============ RESTART SERVICES ============
            echo "ðŸ”„ Restarting services..."
            
            cd "$APP_PATH"
            
            # Check if PM2 processes exist, if not start them
            if pm2 list | grep -q "online\|stopped"; then
              pm2 restart all
              echo "âœ… PM2 processes restarted"
            else
              echo "âš ï¸ No PM2 processes found. Starting services..."
              # Start backend
              cd backend
              pm2 start "python3 -m uvicorn server:app --host 0.0.0.0 --port 8001" --name backend
              cd ..
              # Serve frontend build
              pm2 serve frontend/build 3000 --name frontend --spa
              pm2 save
              echo "âœ… PM2 processes started"
            fi
            
            pm2 list
            
            # Restart nginx if exists
            systemctl restart nginx 2>/dev/null && echo "âœ… Nginx restarted" || true
            
            echo "âœ… Deployment complete!"
