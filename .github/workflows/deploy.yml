name: Deploy to Hetzner

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 46.225.75.191
          username: root
          key: ${{ secrets.HETZNER_SSH_KEY }}
          port: 22
          command_timeout: 30m
          script: |
            set -e
            
            APP_PATH="/opt/paramedic-care"
            echo "=========================================="
            echo "SAFE DEPLOYMENT - Protecting all data"
            echo "=========================================="
            
            # Fix git permissions and identity
            git config --global --add safe.directory "$APP_PATH"
            git config --global user.email "deploy@paramedic-care018.rs"
            git config --global user.name "Deploy Bot"
            cd "$APP_PATH"
            
            # ============ PROTECT DATA ============
            echo "1. Backing up uploads folder..."
            cp -r uploads /tmp/uploads_backup 2>/dev/null || true
            cp -r backend/uploads /tmp/backend_uploads_backup 2>/dev/null || true
            
            # ============ SAFE CODE UPDATE ============
            echo "2. Pulling code..."
            git fetch origin main
            git reset --hard origin/main
            
            # ============ RESTORE UPLOADS ============
            echo "3. Restoring uploads folders..."
            mkdir -p uploads
            mkdir -p backend/uploads
            cp -r /tmp/uploads_backup/* uploads/ 2>/dev/null || true
            cp -r /tmp/backend_uploads_backup/* backend/uploads/ 2>/dev/null || true
            
            # ============ INSTALL NODE IF NEEDED ============
            echo "4. Checking Node.js..."
            if ! /usr/local/bin/node -v 2>/dev/null | grep -q "v20"; then
              echo "Installing Node.js 20..."
              snap install node --classic --channel=20 2>/dev/null || true
              ln -sf /snap/bin/node /usr/local/bin/node
              ln -sf /snap/bin/npm /usr/local/bin/npm
            fi
            echo "Node version: $(/usr/local/bin/node -v)"
            
            # ============ BACKEND DEPENDENCIES ============
            echo "5. Installing backend dependencies..."
            cd "$APP_PATH/backend"
            pip3 install -r requirements.txt --quiet 2>/dev/null || true
            
            # ============ FRONTEND BUILD ============
            echo "6. Building frontend..."
            cd "$APP_PATH/frontend"
            
            # CRITICAL: Delete old build to force new JS bundle hash
            echo "Removing old build folder..."
            rm -rf build
            
            # Clean install to fix ajv issue
            echo "Cleaning old modules..."
            rm -rf node_modules package-lock.json
            
            echo "Installing npm packages..."
            /usr/local/bin/npm install --legacy-peer-deps
            
            # Fix ajv dependency issue
            echo "Fixing ajv..."
            /usr/local/bin/npm install ajv@8 --save-dev --legacy-peer-deps
            
            # Build
            echo "Running build..."
            CI=false /usr/local/bin/npm run build
            
            # Verify build succeeded
            if [ ! -f "build/index.html" ]; then
              echo "ERROR: Build failed"
              exit 1
            fi
            echo "Build successful!"
            
            # ============ RESTART SERVICES ============
            echo "7. Restarting services..."
            cd "$APP_PATH"
            
            # Install PM2 if needed
            if ! command -v pm2 &> /dev/null; then
              echo "Installing PM2..."
              /usr/local/bin/npm install -g pm2
            fi
            
            /usr/local/bin/pm2 restart all 2>/dev/null || {
              /usr/local/bin/pm2 delete all 2>/dev/null || true
              cd backend
              /usr/local/bin/pm2 start "uvicorn server:app --host 0.0.0.0 --port 8001" --name backend
              cd ../frontend
              /usr/local/bin/pm2 serve build 3000 --name frontend --spa
              /usr/local/bin/pm2 save
            }
            
            systemctl restart nginx 2>/dev/null || true
            
            # Clear any nginx cache
            rm -rf /var/cache/nginx/* 2>/dev/null || true
            
            echo "=========================================="
            echo "DEPLOYMENT COMPLETE!"
            echo "==========================================" 
