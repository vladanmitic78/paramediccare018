name: Deploy to Hetzner

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 46.225.75.191
          username: root
          key: ${{ secrets.HETZNER_SSH_KEY }}
          port: 22
          command_timeout: 30m
          script: |
            set -e
            
            APP_PATH="/opt/paramedic-care"
            echo "=========================================="
            echo "SAFE DEPLOYMENT - Protecting all data"
            echo "=========================================="
            
            # Fix git permissions and identity
            git config --global --add safe.directory "$APP_PATH"
            git config --global user.email "deploy@paramedic-care018.rs"
            git config --global user.name "Deploy Bot"
            cd "$APP_PATH"
            
            # ============ PROTECT DATA ============
            echo "1. Backing up uploads folder..."
            cp -r uploads /tmp/uploads_backup 2>/dev/null || true
            cp -r backend/uploads /tmp/backend_uploads_backup 2>/dev/null || true
            
            # ============ SAFE CODE UPDATE ============
            echo "2. Pulling code..."
            git fetch origin main
            git reset --hard origin/main
            
            # ============ RESTORE UPLOADS ============
            echo "3. Restoring uploads folders..."
            mkdir -p uploads
            mkdir -p backend/uploads
            cp -r /tmp/uploads_backup/* uploads/ 2>/dev/null || true
            cp -r /tmp/backend_uploads_backup/* backend/uploads/ 2>/dev/null || true
            
            # ============ INSTALL NODE IF NEEDED ============
            echo "4. Checking Node.js..."
            if ! /usr/local/bin/node -v 2>/dev/null | grep -q "v20"; then
              echo "Installing Node.js 20..."
              snap install node --classic --channel=20 2>/dev/null || true
              ln -sf /snap/bin/node /usr/local/bin/node
              ln -sf /snap/bin/npm /usr/local/bin/npm
            fi
            echo "Node version: $(/usr/local/bin/node -v)"
            
            # ============ BACKEND DEPENDENCIES ============
            echo "5. Installing backend dependencies..."
            cd "$APP_PATH/backend"
            pip3 install -r requirements.txt --quiet 2>/dev/null || true
            
            # ============ FRONTEND BUILD ============
            echo "6. Building frontend..."
            cd "$APP_PATH/frontend"
            
            # CRITICAL: Delete old build to force new JS bundle hash
            echo "Removing old build folder..."
            rm -rf build
            
            # Clean install to fix ajv issue
            echo "Cleaning old modules..."
            rm -rf node_modules package-lock.json
            
            echo "Installing npm packages..."
            /usr/local/bin/npm install --legacy-peer-deps
            
            # Fix ajv dependency issue
            echo "Fixing ajv..."
            /usr/local/bin/npm install ajv@8 --save-dev --legacy-peer-deps
            
            # Build
            echo "Running build..."
            CI=false /usr/local/bin/npm run build
            
            # Verify build succeeded
            if [ ! -f "build/index.html" ]; then
              echo "ERROR: Build failed"
              exit 1
            fi
            echo "Build successful!"
            
            # ============ RESTART SERVICES ============
            echo "7. Restarting services..."
            cd "$APP_PATH"
            
            # Install PM2 if needed
            if ! command -v pm2 &> /dev/null; then
              echo "Installing PM2..."
              /usr/local/bin/npm install -g pm2
            fi
            
            # Stop all existing PM2 processes
            /usr/local/bin/pm2 delete all 2>/dev/null || true
            
            # Start backend with correct command
            cd "$APP_PATH/backend"
            /usr/local/bin/pm2 start "python3 -m uvicorn server:app --host 0.0.0.0 --port 8001" --name backend
            
            # Start frontend server
            cd "$APP_PATH/frontend"
            /usr/local/bin/pm2 serve build 3000 --name frontend --spa
            
            # Save PM2 config
            /usr/local/bin/pm2 save
            
            # Show status
            /usr/local/bin/pm2 status
            
            # ============ FIX NGINX CONFIG ============
            echo "8. Checking nginx configuration..."
            
            # Show current nginx config for debugging
            echo "Current nginx sites-enabled:"
            ls -la /etc/nginx/sites-enabled/ 2>/dev/null || true
            
            # Show FULL nginx config content
            echo "=== FULL NGINX CONFIG ==="
            cat /etc/nginx/sites-enabled/paramedic-care018 2>/dev/null || cat /etc/nginx/sites-enabled/default 2>/dev/null || true
            echo "=== END NGINX CONFIG ==="
            
            # Find where nginx root is configured
            NGINX_ROOT=$(grep -r "root " /etc/nginx/sites-enabled/ 2>/dev/null | grep -v "#" | head -1 | awk '{print $2}' | tr -d ';')
            echo "Detected nginx root: $NGINX_ROOT"
            
            # Copy build to detected nginx root
            if [ -n "$NGINX_ROOT" ] && [ -d "$NGINX_ROOT" ]; then
              echo "Copying build to nginx root: $NGINX_ROOT"
              rm -rf "$NGINX_ROOT"/*
              cp -r /opt/paramedic-care/frontend/build/* "$NGINX_ROOT"/
              echo "Files in nginx root:"
              ls -la "$NGINX_ROOT"/static/js/ | head -5
            fi
            
            # Also copy to common locations just in case
            for DIR in /var/www/html /var/www/paramedic-care /var/www/paramedic-care018; do
              if [ -d "$DIR" ]; then
                echo "Also copying to $DIR..."
                rm -rf "$DIR"/*
                cp -r /opt/paramedic-care/frontend/build/* "$DIR"/
              fi
            done
            
            systemctl restart nginx 2>/dev/null || true
            
            # Clear any nginx cache
            rm -rf /var/cache/nginx/* 2>/dev/null || true
            
            echo "=========================================="
            echo "DEPLOYMENT COMPLETE!"
            echo "New JS bundle: $(ls /opt/paramedic-care/frontend/build/static/js/main.*.js 2>/dev/null | head -1)"
            echo "==========================================" 
